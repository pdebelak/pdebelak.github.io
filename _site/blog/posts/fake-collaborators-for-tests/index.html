<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fake Collaborators for Tests | Peter Debelak</title>
    <meta name="description" content="Use dependency injection to only test the things you care about">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <style>
      h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h1 small,h1 .small,h2 small,h2 .small,h3 small,h3 .small,h4 small,h4 .small,h5 small,h5 .small,h6 small,h6 .small,.h1 small,.h1 .small,.h2 small,.h2 .small,.h3 small,.h3 .small,.h4 small,.h4 .small,.h5 small,.h5 .small,.h6 small,.h6 .small{font-weight:normal;line-height:1;color:#777}h1,.h1,h2,.h2,h3,.h3{margin-top:20px;margin-bottom:10px}h1 small,h1 .small,.h1 small,.h1 .small,h2 small,h2 .small,.h2 small,.h2 .small,h3 small,h3 .small,.h3 small,.h3 .small{font-size:65%}h4,.h4,h5,.h5,h6,.h6{margin-top:10px;margin-bottom:10px}h4 small,h4 .small,.h4 small,.h4 .small,h5 small,h5 .small,.h5 small,.h5 .small,h6 small,h6 .small,.h6 small,.h6 .small{font-size:75%}h1,.h1{font-size:36px}h2,.h2{font-size:30px}h3,.h3{font-size:24px}h4,.h4{font-size:18px}h5,.h5{font-size:14px}h6,.h6{font-size:12px}p{margin:0 0 10px}small,.small{font-size:85%}.text-right{text-align:right}.pull-left{float:left !important}ul,ol{margin-top:0;margin-bottom:10px}ul ul,ul ol,ol ul,ol ol{margin-bottom:0}code{padding:2px 4px;font-size:90%;color:#333;background-color:#f9f2f4;border-radius:4px}pre{display:block;padding:9.5px;margin:0 0 10px;font-size:13px;line-height:1.42857;word-break:break-all;word-wrap:break-word;color:#333;background-color:#f5f5f5;border:1px solid #ccc;border-radius:4px}pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0}*{box-sizing:border-box}*:before,*:after{box-sizing:border-box}html{font-size:10px;-webkit-tap-highlight-color:transparent}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857;color:#333;background-color:#fff}a{color:#017890;text-decoration:none}a:hover,a:focus{color:#003944;text-decoration:underline}a:focus{outline:thin dotted;outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}img{vertical-align:middle;max-width:100%}hr{margin-top:20px;margin-bottom:20px;border:0;border-top:1px solid #eee}html,body{height:100%;margin:0}code,pre{font-family:Menlo,Monaco,Consolas,"Courier New",monospace}header,footer{margin-right:auto;margin-left:auto;padding-left:15px;padding-right:15px;background-color:#017890}header:before,header:after,footer:before,footer:after{content:" ";display:table}header:after,footer:after{clear:both}div.wrapper{min-height:100%;margin-bottom:-39px}main{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}main:before,main:after{content:" ";display:table}main:after{clear:both}@media (min-width: 768px){main{width:750px}}@media (min-width: 992px){main{width:970px}}@media (min-width: 1200px){main{width:1170px}}.main-nav{margin-bottom:20px;padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}.main-nav ul{padding:0;list-style:none;margin:0}.main-nav ul li a{color:#017890;padding:10px 15px;border-radius:4px;display:block;text-decoration:none}.main-nav ul li a:hover,.main-nav ul li a:focus{text-decoration:none;background-color:#eee}.main-nav ul li.active a,.main-nav ul li.active a:hover,.main-nav ul li.active a:focus{color:#fff;background-color:#017890}@media (min-width: 768px){.main-nav{float:left;width:34%}}@media (min-width: 992px){.main-nav{float:left;width:25%}}@media (min-width: 768px){.main-nav{float:right}}@media (max-width: 767px){.main-nav ul>li>a{padding:5px 10px}}.main-content{padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}@media (min-width: 768px){.main-content{float:left;width:66%}}@media (min-width: 992px){.main-content{float:left;width:75%}}header{margin-bottom:10px}@media (min-width: 768px){header{margin-bottom:30px}}footer,.push{width:100%;height:39px}.push{margin-top:30px}header a,footer a,header a:focus,footer a:focus{text-decoration:none;color:#fff}footer .pull-left{color:#fff;margin-top:10px;display:none}@media (min-width: 768px){footer .pull-left{display:inline}}header a:hover,footer a:hover{text-decoration:none;color:#f7feff}.welcome,.recent-posts{margin-left:-15px;margin-right:-15px}.welcome:before,.welcome:after,.recent-posts:before,.recent-posts:after{content:" ";display:table}.welcome:after,.recent-posts:after{clear:both}.recent-posts .posts{padding-right:15px;padding-left:15px}@media (min-width: 768px){.recent-posts .posts{float:left;width:100%}}.home-nav,.explanation{padding-right:15px;padding-left:15px}@media (min-width: 768px){.home-nav,.explanation{float:left;width:50%}}.post-title{margin-top:0;margin-bottom:0;font-size:16px;color:inherit}.home-nav{margin-bottom:20px}.home-nav ul{padding:0;list-style:none;margin:0}.home-nav ul li a{color:#017890;padding:10px 15px;border-radius:4px;display:block;text-decoration:none}.home-nav ul li a:hover,.home-nav ul li a:focus{text-decoration:none;background-color:#eee}.home-nav ul li.active a,.home-nav ul li.active a:hover,.home-nav ul li.active a:focus{color:#fff;background-color:#017890}.nav-pills>li>a{color:#017890}p.date-line{font-size:.75em;color:gray}.resume-title{text-align:center}.resume-section{margin-left:-15px;margin-right:-15px}.resume-section:before,.resume-section:after{content:" ";display:table}.resume-section:after{clear:both}.resume-section .section-title{padding-right:15px;padding-left:15px}@media (min-width: 992px){.resume-section .section-title{float:left;width:17%}}.resume-section .section-body{padding-right:15px;padding-left:15px}@media (min-width: 992px){.resume-section .section-body{float:left;width:83%}}.pager{padding-left:0;margin:20px 0;list-style:none;text-align:center;overflow:auto}.pager li{display:inline}.pager li a{display:inline-block;padding:5px 14px;background-color:#fff;border:1px solid #ddd;border-radius:15px}.pager li a:hover,.pager li a:focus{text-decoration:none;background-color:#eee}.pager .next{float:right}.pager .previous{float:left}h1.blog-index{font-size:30px}h1.blog-index small{font-size:14px}.lead{margin:0 0 10px;font-size:16px;margin-bottom:20px;font-weight:300;line-height:1.4}@media (min-width: 768px){.lead{font-size:21px}}.recent-posts,.home-nav{margin-top:30px}img{max-width:100%}
    </style>
    <script>
      if (document.location.hostname.match('peterdebelak.com')) {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-64190606-1', 'auto');
        ga('send', 'pageview');
      }
    </script>
  </head>
  <body >
    <div class="wrapper">
      <header class="container-fluid">
        <h1><a id="home" href="/">Peter Debelak</a></h1>
      </header>

      <main>
        <nav class="main-nav" id="sidebar" role="navigation">
  <ul>
    <li class=""><a id="about" href="/about/">About</a></li>
    <li class=""><a id="resume" href="/resume/">Resume</a></li>
    <li class="active"><a id="blog" href="/blog/posts">Blog</a></li>
    <li><a id="github" href="https://github.com/pdebelak">Peter on Github</a></li>
  </ul>
</nav>

<div class="main-content" id="main-content">
  <h1>Fake Collaborators for Tests</h1>
<p class="date-line">Last updated 08 September 2015</p>
<p>When I was first learning about testing I thought changing your code to make it easier to test was stupid. Since you are only supposed to test the public interface of a class, it seemed like cheating to fake out anything internal to a class. Over time, though, I realized that testing in this way lead to a bunch of unnecessary setup (usually creating a bunch of objects in the database) that I didn’t need. Take this typical (if extremely simple) use case class:</p>

<pre><code>class PublishArticle
  def initialize(article:)
    @article = article
  end

  def publish
    article.update(state: "published", published_at: Time.now) if should_publish?
  end

  private

  attr_reader :article

  def should_publish?
    ArticlePublishingPolicy.new(article: article).valid?
  end
end
</code></pre>

<p>It’s pretty straight-forward — it just publishes an article if the article meets the article publishing policy. How should we test this? Previously, I would look up what the <code>ArticlePublishingPolicy</code> class did and see something like this:</p>

<pre><code>class ArticlePublishingPolicy
  def initialize(article:)
    @article = article
  end

  def valid?
    author_in_good_standing? &amp;&amp; article_valid?
  end

  private

  attr_reader :article

  def author_in_good_standing?
    article.author.in_good_standing?
  end

  def article_valid?
    article.valid? &amp;&amp; article.approved_by_editor?
  end
end
</code></pre>

<p>To use this class I need to have an article that is valid, plus the article needs an author who is in good standing (and what does that mean?). I could create an author, who is in good standing (that would mean looking at the class of the author to see how to make that the case), plus I’d need to make sure I put all the correct information into an article to make it valid for publishing, like marking it approved by and editor. This seems like a lot of work that is totally unrelated to the <code>PublishArticle</code> class.</p>

<p>What if I changed the <code>PublishArticle</code> class to this?</p>

<pre><code>class PublishArticle
  def initialize(article:, policy: nil)
    @article = article
    @policy = policy
  end

  def publish
    article.update(state: "published", published_at: Time.now) if should_publish?
  end

  private

  attr_reader :article

  def should_publish?
    policy.valid?
  end

  def policy
    @policy ||= ArticlePublishingPolicy.new(article: article)
  end
end
</code></pre>

<p>That let’s me write tests like this (in rspec, and assuming <code>Article</code> responds to <code>published?</code>):</p>

<pre><code>describe "PublishArticle#publish" do
  let(:article) { Article.new }

  def publish_article
    PublishArticle.new(article: article, policy: policy).publish
  end

  context "policy is valid" do
    let(:policy) { double("ValidPolicy", valid?: true) }

    it "publishes the article" do
      publish_article.should be_published
    end

    it "sets published_at" do
      publish_article.published_at.should_not be_nil
    end
  end

  context "policy is invalid" do
    let(:policy) { double("InvalidPolicy", valid?: false) }

    it "does not publish the article" do
      publish_article.should_not be_published
    end

    it "doesn't set published_at" do
      publish_article.published_at.should be_nil
    end
  end
end
</code></pre>

<p>All of the sudden these tests don’t test anything that the <code>PublishArticle</code> class doesn’t care about. It doesn’t need to know about what makes an article valid, so we don’t test that here. Testing in this way makes tests faster, clearer, and less likely to change. Now, if something about the <code>ArticlePublishingPolicy</code> has to change, there is no reason to change the code in <code>PublishArticle</code> or your tests for it. Plus, you don’t need to change how you call <code>PublishArticle</code> in your production code to use this technique since we’ve provided sensible defaults.</p>

<p>I hope this encourages people new to testing to change their code just for test purposes. Inject those dependencies!</p>


<nav>
  <ul class="pager">
    
      <li class="previous">
        <a id="next" href="/blog/posts/managing-configuration-on-multiple-machines/">&larr; Older post</a>
      </li>
    
    
  </ul>
</nav>

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
  var disqus_shortname = 'peterdebelak';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

</div>

      </main>
      <div class="push"></div>
    </div>
    <footer class="container-fluid">
      <span class="pull-left">Press <code>?</code> for help</span>
      <h4 class="text-right">
        <a href="mailto:pdebelak@gmail.com">Contact Peter</a>
      </h4>
    </footer>
    <script src="/js/shortcuts.min.js"></script>
    <script type="text/javascript">
      var disqus_shortname = 'peterdebelak';
      (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
  </body>
</html>
