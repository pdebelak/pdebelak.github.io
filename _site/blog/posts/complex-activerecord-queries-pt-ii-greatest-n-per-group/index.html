<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Complex ActiveRecord Queries Pt. II - Greatest N Per Group | Peter Debelak</title>
    <meta name="description" content="How to find the greatest item in a group in ActiveRecord and Rails">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <style>
      
      *{box-sizing:border-box}*:before,*:after{box-sizing:border-box}html{font-size:10px;-webkit-tap-highlight-color:transparent}body{font-family:Verdana,Geneva,sans-serif;font-size:14px;line-height:1.42857;color:#333;background-color:#fff}img{vertical-align:middle;max-width:100%}html,body{height:100%;margin:0}div.wrapper{min-height:100%;margin-bottom:-39px}.main-header{margin-bottom:10px}@media (min-width: 768px){.main-header{margin-bottom:30px}}.main-header,.main-footer{margin-right:auto;margin-left:auto;padding-left:15px;padding-right:15px;background-color:#017890}.main-header:before,.main-header:after,.main-footer:before,.main-footer:after{content:" ";display:table}.main-header:after,.main-footer:after{clear:both}.main-footer,.push{width:100%;height:39px}.push{margin-top:30px}.main-header a,.main-footer a,.main-header a:focus,.main-footer a:focus{text-decoration:none;color:#fff}main{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}main:before,main:after{content:" ";display:table}main:after{clear:both}@media (min-width: 768px){main{width:750px}}@media (min-width: 992px){main{width:970px}}@media (min-width: 1200px){main{width:1170px}}.main-nav{margin-bottom:20px;padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}.main-nav ul{padding:0;list-style:none;margin:0}.main-nav ul li a{color:#017890;padding:10px 15px;border-radius:4px;display:block;text-decoration:none}.main-nav ul li a:hover,.main-nav ul li a:focus{text-decoration:none;background-color:#eee}.main-nav ul li.active a,.main-nav ul li.active a:hover,.main-nav ul li.active a:focus{color:#fff;background-color:#017890}@media (min-width: 768px){.main-nav{float:left;width:34%}}@media (min-width: 992px){.main-nav{float:left;width:25%}}@media (min-width: 768px){.main-nav{float:right}}@media (max-width: 767px){.main-nav ul>li>a{padding:5px 10px}}.main-content{padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}@media (min-width: 768px){.main-content{float:left;width:66%}}@media (min-width: 992px){.main-content{float:left;width:75%}}.content-wrap{margin-left:-15px;margin-right:-15px}.content-wrap:before,.content-wrap:after{content:" ";display:table}.content-wrap:after{clear:both}.lead{margin:0 0 10px;font-size:16px;margin-bottom:20px;font-weight:300;line-height:1.4}@media (min-width: 768px){.lead{font-size:21px}}h1,.h1{font-size:36px}h2,.h2{font-size:30px}h3,.h3{font-size:24px}h4,.h4{font-size:18px}h5,.h5{font-size:14px}h6,.h6{font-size:12px}h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-family:inherit;font-weight:500;line-height:1.1;color:inherit;margin-top:20px;margin-bottom:10px}h1 small,h1 .small,h2 small,h2 .small,h3 small,h3 .small,h4 small,h4 .small,h5 small,h5 .small,h6 small,h6 .small,.h1 small,.h1 .small,.h2 small,.h2 .small,.h3 small,.h3 .small,.h4 small,.h4 .small,.h5 small,.h5 .small,.h6 small,.h6 .small{font-weight:normal;line-height:1;color:#777;font-size:65%}p{margin:0 0 10px}

    </style>
    <script>
      if (document.location.hostname.match('peterdebelak.com')) {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-64190606-1', 'auto');
        ga('send', 'pageview');
      }
    </script>
  </head>
  <body >
    <div class="wrapper">
      <header class="main-header">
        <h1><a id="home" href="/">Peter Debelak</a></h1>
      </header>

      <main>
        <div class="content-wrap">
  <nav class="main-nav" role="navigation">
    <ul>
      <li class=""><a id="about" href="/about/">About</a></li>
      <li class=""><a id="resume" href="/resume/">Resume</a></li>
      <li class="active"><a id="blog" href="/blog/posts">Blog</a></li>
      <li><a id="github" href="https://github.com/pdebelak">Peter on Github</a></li>
    </ul>
  </nav>

  <section class="main-content">
    <article class="post">
  <header>
    <h1>Complex ActiveRecord Queries Pt. II - Greatest N Per Group</h1>
    <p class="date-line">Last updated 12 February 2015</p>
  </header>
  <p>It is time again to get ridiculous with ActiveRecord. <a href="/blog/posts/complex-activerecord-queries-with-includes">Last time</a> I talked about dealing with <code>includes</code> and sorting. Today I'll talk about an issue I had with sorting by a <code>one-to-many</code> relationship.</p>

<p class="lead">The situation</p>
<ul>
<li><code>User</code>s have many <code>Subscription</code>s</li>
<li>A <code>User</code>'s end date (when they are no longer active) is based on the <code>expiration_date</code> of the <em>last</em> <code>Subscription</code> that user has</li>
<li>You want to order the <code>User</code>s by end date</li>
</ul>
<p>Okay! Great! Should be easy. You want to write this:</p>
<pre>
User.joins(:subscriptions).order('subscriptions.expiration_date ASC')
</pre>
<p class="lead">The problem</p>
<p>It doesn't work. Of course.</p>
<p>Why? Because if a <code>User</code> has more than one <code>Subscription</code> which one should be used for ordering? That code doesn't really make sense.</p>
<p>After some googling around I discovered that there's a name for this problem - greatest n per group. (By the way, isn't it annoying when it would be so easy to find the answer to something if you only knew the name? It's like the old joke about not being able to look up something in the dictionary to see how it's spelled unless you know how it's spelled.) In this case we want to find the latest (instead of greatest) <code>Subscription</code> in each group of <code>Subscription</code>s owned by each <code>User</code>. I found <a href="http://spin.atomicobject.com/2012/09/21/using-activerecord-to-abstract-greatest-n-per-group-queries/">this excellent blog post</a> showing how to solve that problem in ActiveRecord.</p>
<p>After spending time trying to grok the post (it is confusing!) I produced this:</p>
<pre>
User.joins(:subscriptions).joins('LEFT OUTER JOIN subscriptions sp ON (subscriptions.expiration_date &lt; sp.expiration_date and subscriptions.user_id = sp.user_id)').where('sp.id IS NULL').order('subscriptions.expiration_date ASC')
</pre>
<p>So simple! <code>sp</code> is an arbitrary name representing the <code>Subscription</code> that is later than the one represented by <code>subscriptions</code>. You keep searching until <code>sp.id IS NULL</code>, meaning that <code>subscriptions</code> represents the latest <code>Subscription</code> for that <code>User</code>.</p>
<p>As I'm sure you predicted, this doesn't work either. Postgres immediately complains that you can't order by something you aren't selecting (why didn't it complain in the first case? I don't know, ActiveRecord).</p>
<p>Okay! We'll just select that too:</p>
<pre>
User.joins(:subscriptions).select('users.*, subscriptions.expiration_date').joins('LEFT OUTER JOIN subscriptions sp ON (subscriptions.expiration_date &lt; sp.expiration_date and subscriptions.user_id = sp.user_id)').where('sp.id IS NULL').order('subscriptions.expiration_date ASC')
</pre>
<p>Another beautiful ActiveRecord query. Just as a note, I really like ActiveRecord because it makes 99% of all the queries you do beautiful and semantic. Unfortunately, that other 1% is out there to get you.</p>
<p>I hope this helps someone trying to fight with ActiveRecord to sort by a single instance in a <code>has_many</code> relationship!</p>

</article>

<nav>
  <ul class="pager">
    
      <li class="previous">
        <a id="next" href="/blog/posts/jump_back-a-new-gem-to-improve-redirecting-back-in-rails/">&larr; Older post</a>
      </li>
    
    
      <li class="next">
        <a id="previous" href="/blog/posts/switching-away-from-angular/">Newer post &rarr;</a>
      </li>
    
  </ul>
</nav>

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
  var disqus_shortname = 'peterdebelak';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

  </section>
</div>

      </main>
      <div class="push"></div>
    </div>
    <footer class="main-footer">
      <span class="pull-left">Press <code>?</code> for help</span>
      <p class="mail-link">
        <a href="mailto:pdebelak@gmail.com">Contact Peter</a>
      </p>
    </footer>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/shortcuts.min.js"></script>
    <script type="text/javascript">
      var disqus_shortname = 'peterdebelak';
      (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
  </body>
</html>
