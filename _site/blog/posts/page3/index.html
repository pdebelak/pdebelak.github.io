<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blog | Peter Debelak</title>
    <meta name="description" content="Posts about Ruby, Rails, and other technical topics from Peter Debelak">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <style>
      h1,h2,h3,h4,h5,h6,.h1,.h2,.h3,.h4,.h5,.h6{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h1 small,h1 .small,h2 small,h2 .small,h3 small,h3 .small,h4 small,h4 .small,h5 small,h5 .small,h6 small,h6 .small,.h1 small,.h1 .small,.h2 small,.h2 .small,.h3 small,.h3 .small,.h4 small,.h4 .small,.h5 small,.h5 .small,.h6 small,.h6 .small{font-weight:normal;line-height:1;color:#777}h1,.h1,h2,.h2,h3,.h3{margin-top:20px;margin-bottom:10px}h1 small,h1 .small,.h1 small,.h1 .small,h2 small,h2 .small,.h2 small,.h2 .small,h3 small,h3 .small,.h3 small,.h3 .small{font-size:65%}h4,.h4,h5,.h5,h6,.h6{margin-top:10px;margin-bottom:10px}h4 small,h4 .small,.h4 small,.h4 .small,h5 small,h5 .small,.h5 small,.h5 .small,h6 small,h6 .small,.h6 small,.h6 .small{font-size:75%}h1,.h1{font-size:36px}h2,.h2{font-size:30px}h3,.h3{font-size:24px}h4,.h4{font-size:18px}h5,.h5{font-size:14px}h6,.h6{font-size:12px}p{margin:0 0 10px}small,.small{font-size:85%}.text-right{text-align:right}.pull-left{float:left !important}ul,ol{margin-top:0;margin-bottom:10px}ul ul,ul ol,ol ul,ol ol{margin-bottom:0}code{padding:2px 4px;font-size:90%;color:#333;background-color:#f9f2f4;border-radius:4px}pre{display:block;padding:9.5px;margin:0 0 10px;font-size:13px;line-height:1.42857;word-break:break-all;word-wrap:break-word;color:#333;background-color:#f5f5f5;border:1px solid #ccc;border-radius:4px}pre code{padding:0;font-size:inherit;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0}*{box-sizing:border-box}*:before,*:after{box-sizing:border-box}html{font-size:10px;-webkit-tap-highlight-color:transparent}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857;color:#333;background-color:#fff}a{color:#017890;text-decoration:none}a:hover,a:focus{color:#003944;text-decoration:underline}a:focus{outline:thin dotted;outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}img{vertical-align:middle;max-width:100%}hr{margin-top:20px;margin-bottom:20px;border:0;border-top:1px solid #eee}html,body{height:100%;margin:0}code,pre{font-family:Menlo,Monaco,Consolas,"Courier New",monospace}header,footer{margin-right:auto;margin-left:auto;padding-left:15px;padding-right:15px;background-color:#017890}header:before,header:after,footer:before,footer:after{content:" ";display:table}header:after,footer:after{clear:both}div.wrapper{min-height:100%;margin-bottom:-39px}main{padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}main:before,main:after{content:" ";display:table}main:after{clear:both}@media (min-width: 768px){main{width:750px}}@media (min-width: 992px){main{width:970px}}@media (min-width: 1200px){main{width:1170px}}.main-nav{margin-bottom:20px;padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}.main-nav ul{padding:0;list-style:none;margin:0}.main-nav ul li a{color:#017890;padding:10px 15px;border-radius:4px;display:block;text-decoration:none}.main-nav ul li a:hover,.main-nav ul li a:focus{text-decoration:none;background-color:#eee}.main-nav ul li.active a,.main-nav ul li.active a:hover,.main-nav ul li.active a:focus{color:#fff;background-color:#017890}@media (min-width: 768px){.main-nav{float:left;width:34%}}@media (min-width: 992px){.main-nav{float:left;width:25%}}@media (min-width: 768px){.main-nav{float:right}}@media (max-width: 767px){.main-nav ul>li>a{padding:5px 10px}}.main-content{padding-right:15px;padding-left:15px;padding-right:15px;padding-left:15px}@media (min-width: 768px){.main-content{float:left;width:66%}}@media (min-width: 992px){.main-content{float:left;width:75%}}header{margin-bottom:10px}@media (min-width: 768px){header{margin-bottom:30px}}footer,.push{width:100%;height:39px}.push{margin-top:30px}header a,footer a,header a:focus,footer a:focus{text-decoration:none;color:#fff}footer .pull-left{color:#fff;margin-top:10px;display:none}@media (min-width: 768px){footer .pull-left{display:inline}}header a:hover,footer a:hover{text-decoration:none;color:#f7feff}.welcome,.recent-posts{margin-left:-15px;margin-right:-15px}.welcome:before,.welcome:after,.recent-posts:before,.recent-posts:after{content:" ";display:table}.welcome:after,.recent-posts:after{clear:both}.recent-posts .posts{padding-right:15px;padding-left:15px}@media (min-width: 768px){.recent-posts .posts{float:left;width:100%}}.home-nav,.explanation{padding-right:15px;padding-left:15px}@media (min-width: 768px){.home-nav,.explanation{float:left;width:50%}}.post-title{margin-top:0;margin-bottom:0;font-size:16px;color:inherit}.home-nav{margin-bottom:20px}.home-nav ul{padding:0;list-style:none;margin:0}.home-nav ul li a{color:#017890;padding:10px 15px;border-radius:4px;display:block;text-decoration:none}.home-nav ul li a:hover,.home-nav ul li a:focus{text-decoration:none;background-color:#eee}.home-nav ul li.active a,.home-nav ul li.active a:hover,.home-nav ul li.active a:focus{color:#fff;background-color:#017890}.nav-pills>li>a{color:#017890}p.date-line{font-size:.75em;color:gray}.resume-title{text-align:center}.resume-section{margin-left:-15px;margin-right:-15px}.resume-section:before,.resume-section:after{content:" ";display:table}.resume-section:after{clear:both}.resume-section .section-title{padding-right:15px;padding-left:15px}@media (min-width: 992px){.resume-section .section-title{float:left;width:17%}}.resume-section .section-body{padding-right:15px;padding-left:15px}@media (min-width: 992px){.resume-section .section-body{float:left;width:83%}}.pager{padding-left:0;margin:20px 0;list-style:none;text-align:center;overflow:auto}.pager li{display:inline}.pager li a{display:inline-block;padding:5px 14px;background-color:#fff;border:1px solid #ddd;border-radius:15px}.pager li a:hover,.pager li a:focus{text-decoration:none;background-color:#eee}.pager .next{float:right}.pager .previous{float:left}h1.blog-index{font-size:30px}h1.blog-index small{font-size:14px}.lead{margin:0 0 10px;font-size:16px;margin-bottom:20px;font-weight:300;line-height:1.4}@media (min-width: 768px){.lead{font-size:21px}}.recent-posts,.home-nav{margin-top:30px}img{max-width:100%}
    </style>
    <script>
      if (document.location.hostname.match('peterdebelak.com')) {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-64190606-1', 'auto');
        ga('send', 'pageview');
      }
    </script>
  </head>
  <body >
    <div class="wrapper">
      <header class="container-fluid">
        <h1><a id="home" href="/">Peter Debelak</a></h1>
      </header>

      <main>
        <nav class="main-nav" id="sidebar" role="navigation">
  <ul>
    <li class=""><a id="about" href="/about/">About</a></li>
    <li class=""><a id="resume" href="/resume/">Resume</a></li>
    <li class="active"><a id="blog" href="/blog/posts">Blog</a></li>
    <li><a id="github" href="https://github.com/pdebelak">Peter on Github</a></li>
  </ul>
</nav>

<div class="main-content" id="main-content">
  
  <h1 class="blog-index">Why You Run Your Tests First<br><small><a href="/blog/posts/why-you-run-your-tests-first/#disqus_thread">comments</a></small></h1>
  <p class="date-line">Last updated 14 June 2015</p>
  <p>When first learning test-driven-development, there are a lot of things about it
that seem stupid and arbitrary. After working with it a while, though, you
start to see that at least some of the rules make a lot of sense. The phrase
most associated with TDD is “red, green, refactor”. Now, when I was first
learning about TDD the green and refactor steps made a lot of sense, but why
do I need to do the red step? I <em>know</em> the test will fail, because I haven’t
written the code yet!</p>

<p>Now I understand, though, so I wanted to share what I learned with future
doubters.</p>

<p class="lead">You only <em>think</em> you know what the bug is</p>

<p>When fixing bugs in a large project at work, I usually have an exception that
occurred in production with details in <a href="https://github.com/honeybadger-io/honeybadger-ruby">honeybadger</a>.
I usually read the trace from the exception and think through where the problem
might be. I then tend to have a very good idea of how to solve the issue.</p>

<p>The only way I <em>know</em> I’m fixing the issue, though, is to write a test that
replicates the problem. Frequently I’ll write the test and, by running it, discover that it
doesn’t actually cause the same exception I expected it to, or that it doesn’t cause
any exception at all! If I wrote the test, changed the code, and then ran the
test I’d think that the bug was fixed. By running the test first I verify that
I’m fixing the thing I think I am.</p>

<p>The same idea applies to writing new features. If you run your tests first,
you can verify that you are getting the error you expect to get. When you write
a test like this:</p>

<pre><code>specify { Thing.new.do_thing.should == "hello" }
</code></pre>

<p>And your current code is:</p>

<pre><code>class Thing
  def do_thing
  end
end
</code></pre>

<p>You run the test to see <code>expected "doing a thing", got nil</code>. This means that
the rest of your code is working as you expect, and your planned code will make
the test pass. Without running the test, you might write your code, then
discover that you mistyped the method name, or that your method is returning
something unexpected. Until you get the failure you want, you don’t really
understand your code.</p>

<p>I hope that helps explain why the seemingly stupid step of running a test you
know will fail is actually helpful.</p>

  <hr>

  <h1 class="blog-index">Switching Away from Angular<br><small><a href="/blog/posts/switching-away-from-angular/#disqus_thread">comments</a></small></h1>
  <p class="date-line">Last updated 27 February 2015</p>
  <p>As I’ve spent more time working with Rails, I’ve realized that, even without
Angular, a Rails site is capable of being fully-interactive, ajax-powered
fun-times machine. I know what you’re thinking: “Duh! That’s true of everything
from plain <code>html</code> to <code>php</code>!” Okay, yes, that’s true. But with Rails you can do
it without really having to translate between server-side and javascript. Here’s
what I mean:</p>

<p class="lead">Unobtrusive Javascript</p>

<p>Using jQuery for a ajax-heavy site is truly obtrusive to your experience to a
developer. Every time you type <code>event.preventDefault()</code> you are saying, “Don’t
do the thing that I wrote code for, do something else that requires more code!”
Angular makes this better with its <code>ng-click</code>s and <code>ng-submit</code>s, but you still
have to spend time formulating a <code>json</code> response, and then translating that
response into html in your javascript.</p>

<p>With unobtrusive javascript, you can respond with a <code>js.erb</code> file that just
inserts a partial you already wrote for the initial <code>html</code> response, so your
total new code is adding <code>format.js</code> to your controller and
<code>$('selector').html('&lt;%= j render partial: "a partial" %&gt;')</code>. Obviously it
can be more complicated than that, but it usually isn’t.</p>

<p class="lead">Degrading Gracefully</p>

<p>Honestly, I don’t think degrading gracefully when javascript is not enabled is
very important, but if I can do it while writing less code than Angular I see
that as a win. It is comforting to know that if my grandma accidentally turned
javascript off in her browser she can still use my site just fine.</p>

<p class="lead">My conclusion</p>

<p>So I removed Angular from this site. I know it doesn’t really matter to users,
but for me it’s made life easier. Since there is less code to write, I’m more
likely to add new features. For example, I’ve already updated the site to use
<code>markdown</code> instead of <code>html</code>, which has made writing posts faster and more fun!</p>

<p>I still think Angular is great and will continue to use it for projects, but I
think when it comes to Rails, I’ll keep using unobtrusive javascript until I
have a real reason not to.</p>

  <hr>

  <h1 class="blog-index">Complex ActiveRecord Queries Pt. II - Greatest N Per Group<br><small><a href="/blog/posts/complex-activerecord-queries-pt-ii-greatest-n-per-group/#disqus_thread">comments</a></small></h1>
  <p class="date-line">Last updated 12 February 2015</p>
  <p>It is time again to get ridiculous with ActiveRecord. <a href="/blog/posts/complex-activerecord-queries-with-includes">Last time</a> I talked about dealing with <code>includes</code> and sorting. Today I'll talk about an issue I had with sorting by a <code>one-to-many</code> relationship.</p>

<p class="lead">The situation</p>
<ul>
<li><code>User</code>s have many <code>Subscription</code>s</li>
<li>A <code>User</code>'s end date (when they are no longer active) is based on the <code>expiration_date</code> of the <em>last</em> <code>Subscription</code> that user has</li>
<li>You want to order the <code>User</code>s by end date</li>
</ul>
<p>Okay! Great! Should be easy. You want to write this:</p>
<pre>
User.joins(:subscriptions).order('subscriptions.expiration_date ASC')
</pre>
<p class="lead">The problem</p>
<p>It doesn't work. Of course.</p>
<p>Why? Because if a <code>User</code> has more than one <code>Subscription</code> which one should be used for ordering? That code doesn't really make sense.</p>
<p>After some googling around I discovered that there's a name for this problem - greatest n per group. (By the way, isn't it annoying when it would be so easy to find the answer to something if you only knew the name? It's like the old joke about not being able to look up something in the dictionary to see how it's spelled unless you know how it's spelled.) In this case we want to find the latest (instead of greatest) <code>Subscription</code> in each group of <code>Subscription</code>s owned by each <code>User</code>. I found <a href="http://spin.atomicobject.com/2012/09/21/using-activerecord-to-abstract-greatest-n-per-group-queries/">this excellent blog post</a> showing how to solve that problem in ActiveRecord.</p>
<p>After spending time trying to grok the post (it is confusing!) I produced this:</p>
<pre>
User.joins(:subscriptions).joins('LEFT OUTER JOIN subscriptions sp ON (subscriptions.expiration_date &lt; sp.expiration_date and subscriptions.user_id = sp.user_id)').where('sp.id IS NULL').order('subscriptions.expiration_date ASC')
</pre>
<p>So simple! <code>sp</code> is an arbitrary name representing the <code>Subscription</code> that is later than the one represented by <code>subscriptions</code>. You keep searching until <code>sp.id IS NULL</code>, meaning that <code>subscriptions</code> represents the latest <code>Subscription</code> for that <code>User</code>.</p>
<p>As I'm sure you predicted, this doesn't work either. Postgres immediately complains that you can't order by something you aren't selecting (why didn't it complain in the first case? I don't know, ActiveRecord).</p>
<p>Okay! We'll just select that too:</p>
<pre>
User.joins(:subscriptions).select('users.*, subscriptions.expiration_date').joins('LEFT OUTER JOIN subscriptions sp ON (subscriptions.expiration_date &lt; sp.expiration_date and subscriptions.user_id = sp.user_id)').where('sp.id IS NULL').order('subscriptions.expiration_date ASC')
</pre>
<p>Another beautiful ActiveRecord query. Just as a note, I really like ActiveRecord because it makes 99% of all the queries you do beautiful and semantic. Unfortunately, that other 1% is out there to get you.</p>
<p>I hope this helps someone trying to fight with ActiveRecord to sort by a single instance in a <code>has_many</code> relationship!</p>

  <hr>

<nav>
  <ul class="pager">
    
      <li class="previous">
        <a id="previous" href="/blog/posts/page2/">&larr; Newer posts</a>
      </li>
    
    
      <li class="next">
        <a id="next" href="/blog/posts/page4/">Older posts &rarr;</a>
      </li>
    
  </ul>
</nav>

</div>

      </main>
      <div class="push"></div>
    </div>
    <footer class="container-fluid">
      <span class="pull-left">Press <code>?</code> for help</span>
      <h4 class="text-right">
        <a href="mailto:pdebelak@gmail.com">Contact Peter</a>
      </h4>
    </footer>
    <script src="/js/main.min.js"></script>
    <script type="text/javascript">
      var disqus_shortname = 'peterdebelak';
      (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
  </body>
</html>
